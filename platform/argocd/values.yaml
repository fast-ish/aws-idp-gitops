# ArgoCD Helm Chart Values
# https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd

global:
  domain: argocd.internal

# Server configuration
server:
  replicas: 2

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-passthrough: "true"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    hosts:
      - argocd.internal
    tls:
      - secretName: argocd-server-tls
        hosts:
          - argocd.internal

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: observability

# Controller configuration
controller:
  replicas: 1

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: observability

# Repo server configuration
repoServer:
  replicas: 2

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: observability

# ApplicationSet controller
applicationSet:
  enabled: true
  replicas: 2

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: observability

# Notifications controller
notifications:
  enabled: true

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: observability

# Redis HA
redis-ha:
  enabled: true
  replicas: 3

  redis:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

# Dex (OIDC provider)
dex:
  enabled: false  # Using GitHub OAuth directly

# RBAC configuration
configs:
  rbac:
    policy.default: role:readonly
    policy.csv: |
      # Platform team has admin access
      p, role:platform-admin, applications, *, */*, allow
      p, role:platform-admin, clusters, *, *, allow
      p, role:platform-admin, repositories, *, *, allow
      p, role:platform-admin, projects, *, *, allow
      p, role:platform-admin, accounts, *, *, allow
      p, role:platform-admin, gpgkeys, *, *, allow
      p, role:platform-admin, logs, *, *, allow
      p, role:platform-admin, exec, *, */*, allow

      # Team leads can manage their team's apps
      p, role:team-lead, applications, *, team-*/*, allow
      p, role:team-lead, logs, get, team-*/*, allow
      p, role:team-lead, exec, create, team-*/*, allow

      # Developers can view and sync apps in their namespace
      p, role:developer, applications, get, */*, allow
      p, role:developer, applications, sync, team-*/*, allow
      p, role:developer, logs, get, team-*/*, allow

      # Map GitHub teams to roles
      g, platform-team, role:platform-admin
      g, backend-leads, role:team-lead
      g, frontend-leads, role:team-lead
      g, developers, role:developer

  params:
    # Application controller settings
    controller.status.processors: 20
    controller.operation.processors: 10
    controller.self.heal.timeout.seconds: 5
    controller.repo.server.timeout.seconds: 60

    # Server settings
    server.insecure: false

    # Repo server settings
    reposerver.parallelism.limit: 0

  cm:
    # Enable status badge
    statusbadge.enabled: true

    # Resource customizations
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs

    # Kustomize build options
    kustomize.buildOptions: --enable-helm

    # Resource exclusions
    resource.exclusions: |
      - apiGroups:
          - cilium.io
        kinds:
          - CiliumIdentity
        clusters:
          - "*"
