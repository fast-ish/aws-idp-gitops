# Kyverno Helm Chart Values
# https://github.com/kyverno/kyverno/tree/main/charts/kyverno

# Admission controller configuration
admissionController:
  replicas: 3

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  serviceMonitor:
    enabled: true
    namespace: observability

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/component: admission-controller

# Background controller configuration
backgroundController:
  replicas: 2

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  serviceMonitor:
    enabled: true
    namespace: observability

# Cleanup controller configuration
cleanupController:
  replicas: 1

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  serviceMonitor:
    enabled: true
    namespace: observability

# Reports controller configuration
reportsController:
  replicas: 1

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  serviceMonitor:
    enabled: true
    namespace: observability

# Features configuration
features:
  admissionReports:
    enabled: true
  aggregateReports:
    enabled: true
  policyReports:
    enabled: true
  validatingAdmissionPolicyReports:
    enabled: true
  autoUpdateWebhooks:
    enabled: true
  backgroundScan:
    enabled: true
    backgroundScanWorkers: 2
    backgroundScanInterval: 1h
  configMapCaching:
    enabled: true
  deferredLoading:
    enabled: true
  forceFailurePolicyIgnore:
    enabled: false
  generateValidatingAdmissionPolicy:
    enabled: false
  globalContext:
    enabled: true
  logging:
    format: json
    verbosity: 2
  omitEvents:
    eventTypes: []
  policyExceptions:
    enabled: true
    namespace: kyverno
  protectManagedResources:
    enabled: false
  registryClient:
    allowInsecure: false
    credentialHelpers:
      - default
      - amazon
  reports:
    chunkSize: 1000

# Webhooks configuration
webhooksCleanup:
  enabled: true
  autoDeleteWebhooks:
    enabled: true

# Config
config:
  # Resource filters - don't apply policies to these resources
  resourceFilters:
    - '[*,kube-system,*]'
    - '[*,kube-public,*]'
    - '[*,kube-node-lease,*]'
    - '[Event,*,*]'
    - '[Node,*,*]'
    - '[APIService,*,*]'
    - '[TokenReview,*,*]'
    - '[SubjectAccessReview,*,*]'
    - '[SelfSubjectAccessReview,*,*]'
    - '[SelfSubjectRulesReview,*,*]'
    - '[Binding,*,*]'
    - '[ReplicaSet,*,*]'
    - '[*,kyverno,*]'

  # Webhook annotations
  webhooks:
    - namespaceSelector:
        matchExpressions:
          - key: kubernetes.io/metadata.name
            operator: NotIn
            values:
              - kube-system
              - kube-public
              - kyverno

# Grafana dashboard
grafana:
  enabled: true
  configMap:
    create: true
    namespace: observability

# Cleanup jobs
cleanupJobs:
  admissionReports:
    enabled: true
    schedule: "*/10 * * * *"
    threshold: 10000
  clusterAdmissionReports:
    enabled: true
    schedule: "*/10 * * * *"
    threshold: 10000
