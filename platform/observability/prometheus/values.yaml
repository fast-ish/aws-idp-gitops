# kube-prometheus-stack Helm Chart Values
# https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack

# Global settings
fullnameOverride: prometheus

# Prometheus configuration
prometheus:
  enabled: true

  prometheusSpec:
    replicas: 2

    retention: 15d
    retentionSize: 45GB

    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi

    # Enable remote write for long-term storage
    remoteWrite:
      - url: ${PROMETHEUS_REMOTE_WRITE_URL}
        writeRelabelConfigs:
          - sourceLabels: [__name__]
            regex: '(up|container_.*|kube_.*|node_.*|apiserver_.*)'
            action: keep

    # Pod monitoring
    podMonitorSelector: {}
    podMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorSelectorNilUsesHelmValues: false
    ruleSelector: {}
    ruleSelectorNilUsesHelmValues: false

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 2000

    # Topology spread
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: prometheus

  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - prometheus.internal
    tls:
      - secretName: prometheus-tls
        hosts:
          - prometheus.internal

# Alertmanager configuration
alertmanager:
  enabled: true

  alertmanagerSpec:
    replicas: 3

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi

    # Use external config from our alertmanager-config.yaml
    useExistingSecret: true
    configSecret: alertmanager-config

  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - alertmanager.internal
    tls:
      - secretName: alertmanager-tls
        hosts:
          - alertmanager.internal

# Grafana - disabled, we use our own
grafana:
  enabled: false

# Node exporter
nodeExporter:
  enabled: true

  resources:
    requests:
      cpu: 50m
      memory: 30Mi
    limits:
      cpu: 200m
      memory: 100Mi

# Kube state metrics
kubeStateMetrics:
  enabled: true

# Prometheus operator
prometheusOperator:
  enabled: true

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Admission webhooks
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true

# Default rules
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # Managed by EKS
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: false  # Managed by EKS
    kubelet: true
    kubeProxy: false  # Managed by EKS
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeSchedulerAlerting: false  # Managed by EKS
    kubeSchedulerRecording: false  # Managed by EKS
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# Additional scrape configs
additionalScrapeConfigs: []

# Thanos sidecar for HA
thanosRuler:
  enabled: false
